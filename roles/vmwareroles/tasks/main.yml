---
- name: "Block for esxi vm config management"
  block:
  - name: "Set role fact for esxi vms"
    shell: |
      /usr/bin/vmware-rpctool "info-get guestinfo.role"
    register: esxirole

  - name: "Set second role fact for esxi vms"
    shell: |
      /usr/bin/vmware-rpctool "info-get guestinfo.secondaryrole"
    register: esxirole2

  - name: "Include roles for vmware servers"
    include_role:
      name: "{{ esxirole.stdout }}"
    when:
    - esxirole.stdout != 'None'

  - name: "Include secondary roles for vmware servers"
    include_role:
      name: "{{ esxirole2.stdout }}"
    when:
    - esxirole2.stdout != 'None'

  rescue:
    - name:
      debug:
        msg: "No vmware role found for this host"

---
- name: "Check if we are entitled for Satellite"
  become: yes
  shell: "subscription-manager list --consumed"
  args:
    executable: /bin/bash
  ignore_errors: yes
  register: rhsm_reg
    
#- name: "Try to Entitle to use Satellite 6"
#  block:
#    - name: "Add Satellite Entitlement to Server"
#      community.general.redhat_subscription:
#        state: present
#        username: "{{ rh_satellite_user }}"
#        password: "{{ rh_satellite_pass }}"
#        pool_ids: "{{ rh_satellite_pool_id }}"
#      become: true
#      register: rhsm_status
#      retries: 10
#      delay: 1
#  when: "'Red Hat Satellite' not in rhsm_reg.stdout"

- name: "Satellite Setup check"
  shell: |
    if [ -e "/root/.setup/fusor.success" ]
    then
      echo "true"
    else
      echo "false"
    fi
  register: initialsetup
  become: true

- name: "grabbing hostname"
  shell: hostname --fqdn
  register: sat6url

- name: "setting the sat6_url fact"
  set_fact:
    sat6_url: "{{ sat6url.stdout }}"

- name: "Updated User data template"
  template:
    dest: /var/tmp/user-data-template.txt
    src: user-data-template.txt.j2
    owner: root
    group: root
    mode: 0644
  become: true

- name: "Block to perform initial setup"
  block:
    - name: "make setup tracking dir"
      file:
        path: /root/.setup
        state: directory
        mode: 0755
      become: true
  
      #add satellite to tower group early
    - include: "tower.yml"

    - name: "Check if this thing has been rebooted by us"
      stat:
        path: /opt/.rebooted
      register: rebooted
    
    - name: Update the thing
      block:
      - name: "Run yum update to avoid a bug. Please wait. SSH to Host and tail /tmp/tower.output for status"
        shell: |
          exec &> >(tee -a /tmp/tower.output)
          yum -y update
        become: true
        args:
          executable: /bin/bash
  
      - name: "Perform a yum clean all"
        shell:  yum clean all
        become: true
  
      - name: "Set reboot in 1 min."
        shell: |
          touch /opt/.rebooted
          shutdown -r +1 || true
        become: true
        args:
          executable: /bin/bash
          creates: /opt/.rebooted
  
      - name: "Wait at least a minute and half, max 6 mins for host to reboot"
        ansible.builtin.wait_for:
          port: 22
          #host: "{{ (ansible_ssh_host | default(ansible_host)) | default(inventory_hostname) }}"
          host: "{{ ansible_default_ipv4['address'] }}"
          search_regex: OpenSSH
          delay: 90
          timeout: 360
        delegate_to: localhost
        become: false
      when: rebooted.stat.exists == false

      rescue:
      - name: "LOl why does it do that?"
        debug: msg="Let's keep going"
          
    - name: "Disabling all repos"
      shell: "subscription-manager repos --disable='*'"
      become: true
    
#    - name: "Enable satellite repos for rhel 7"
#      shell: |
#        subscription-manager repos --enable rhel-7-server-rpms \
#                           --enable rhel-server-rhscl-7-rpms \
#                           --enable rhel-8-server-satellite-{{ satellite_version }}-rpms \
#                           --enable rhel-8-server-satellite-tools-{{ satellite_version }}-rpms \
#                           --enable=rhel-8-server-satellite-maintenance-6-rpms \
#                           --enable=rhel-8-server-ansible-2.9-rpms 
    - name: "Enable satellite repos for rhel 8"
      shell: |
        subscription-manager repos \
                           --enable satellite-6.11-for-rhel-8-x86_64-rpms \
                           --enable satellite-maintenance-6.11-for-rhel-8-x86_64-rpms \
                           --enable=ansible-2.9-for-rhel-8-x86_64-rpms \
                           --enable=rhel-8-for-x86_64-appstream-rpms \
                           --enable=rhel-8-for-x86_64-baseos-rpms
      become: true
    
    - name: "Enable dnf module for rhel 8"
      shell: |
        dnf module enable satellite:el8 -y
      become: true
#    - name: "Turn on notify_only=0 in search-disabled-repos.conf"
#      lineinfile:
#        path: /etc/yum/pluginconf.d/search-disabled-repos.conf
#        regexp: '^notify_only=*'
#        line: 'notify_only=0'
#      become: true
#    
#    - name: "Modify ignore_repo in search-disabled-repos.conf"
#      lineinfile:
#        path: /etc/yum/pluginconf.d/search-disabled-repos.conf
#        regexp: '^ignored_repos=*'
#        line: 'ignored_repos=*debug-rpms *source-rpms'
#      become: true
    
    - name: "Installing satellite rpms"
      yum:
        name: "{{ item }}"
        state: latest
      become: true
      loop:
      - rhel-system-roles
      - satellite

#    - name: "installing private key to accesss OSP"
#      template:
#        src: openstack/blank.key.j2
#        dest: /root/.ssh/id_rsa
#        owner: root
#        group: root
#        mode: 0600
    # fix for satellite
    - name: "Enable dnf module for rhel 8"
      shell: |
        groupadd puppet
      become: true

    - name: "Run fusor installer, takes about 30 mins ..."
      shell: |
        satellite-installer --scenario satellite \
        --foreman-initial-organization "{{ sat6_default_org }}" \
        --foreman-initial-location "{{ sat6_default_location }}" \
        --foreman-initial-admin-password {{ sat6_pass }} \
        --foreman-proxy-puppetca false \
        --foreman-proxy-tftp true \
        --disable-system-checks \
        --enable-foreman-plugin-leapp \
        --enable-foreman-plugin-remote-execution-cockpit \
        --enable-foreman-plugin-templates \
        --enable-foreman-plugin-discovery && touch /root/.setup/fusor.success
      become: true
      args:
        creates: /root/.setup/fusor.success
  
    - name: "make hammer config dir"
      file:
        path: /root/.hammer
        state: directory
        mode: 0755
      become: true
  
    - name: "Configure hammer cli tool"
      template:
          dest: /etc/hammer/cli_config.yml
          src: cli_config.yml.j2
          owner: root
          group: root
          mode: 0644
      become: true
  
    - name: "Setting hammer to use default org and locations"
      shell: |
        hammer user update --login admin \
        --default-location-id 1 \
        --default-organization-id 1 \
        --locations "{{ sat6_default_location }}" \
        --organizations "{{ sat6_default_org }}"
      become: true

    - name: "Configure puppet autosigning"
      template:
          dest: /etc/puppetlabs/puppet/autosign.conf
          src: autosign.conf.j2
          owner: foreman-proxy
          group: puppet
          mode: 0644
      become: true

#    - name: "Restart puppetmaster"
#      shell: systemctl restart puppetserver
#      become: true


#    - name: "Open firewall port for external access to Satellite at sat6.dev.maskedadmins.com:8448"
#      ignore_errors: yes
#      shell: |
#        echo "calling update firewall port for sat6"
#        curl -f -k -H 'Content-Type: application/json' -XPOST -d '{"extra_vars":"{\"int_ip\":\"{{ ansible_default_ipv4['address'] }}\",\"int_port\":\"443\",\"ext_port\":\"8448\"}"}' --user admin:ansible https://{{ tower_server }}:443/api/v1/job_templates/660/launch/

  when: initialsetup.stdout == "false"


#- name: "Creating Orgs for Satellite 6"
#  shell: |
#      hammer organization create --name "{{ item.name }}" --label "{{ item.label }}" \
#      --description "{{ item.description }}"
#  with_items: "{{ sat6.orgs }}"
#  args:
#    creates: /root/.setup/step1
#
#- name: "Org creation Complete"
#  shell: touch /root/.setup/step1
#  args:
#    creates: /root/.setup/step1
#
#- name: "Creating Locations for Satellite 6"
#  shell: |
#      hammer location create --name "{{ item }}"
#  with_items: "{{ sat6.locations }}"
#  args:
#    creates: /root/.setup/step2
#
#- name: "Location creation Complete"
#  shell: touch /root/.setup/step2
#  args:
#    creates: /root/.setup/step2
#
#- name: "Adding Orgs to Locations"
#  shell: |
#      hammer location add-organization --name "{{ item.1 }}" --organization "{{ item.0.name }}"
#  with_subelements:
#    - "{{ sat6.orgs }}"
#    - locations
#  args:
#    creates: /root/.setup/step3
#
#- name: "Org to Location creation Complete"
#  shell: touch /root/.setup/step3
#  args:
#    creates: /root/.setup/step3
#
#  - name: "Setting default org and location Satellite 6"
#    shell: |
#        defaultorg=$(hammer organization list  | grep {{ sat6_default_org }} | awk '{print $1}')
#        defaultloc=$(hammer location list  | grep {{ sat6_default_location }} | awk '{print $1}')
#        hammer defaults add --param-name organization_id --param-value $defaultorg
#        hammer defaults add --param-name location_id --param-value $defaultloc && touch /root/.setup/step1
#    args:
#      creates: /root/.setup/step4

- name: "Subnet and Domain check"
  shell: |
    if [ -e "/root/.setup/step9" ]
    then
      echo "true"
    else
      echo "false"
    fi
  register: subnetstep
  become: true

- name: "Domain and Subnet creation"
  block:
    - name: "Creating domains"
      shell: |
          hammer domain create --name "{{ item }}" || true
      with_items: "{{ sat6.domains }}"
      ignore_errors: yes
      become: true
      args:
        creates: /root/.setup/step4
  
    - name: "Domain creation Complete"
      shell: touch /root/.setup/step4
      become: true
      args:
        creates: /root/.setup/step4
  
    - name: "Creating subnets and adding to domains"
      shell: |
          domainid=$(hammer domain list  | grep "| {{ item.domain }}" | awk '{print $1}')
          hammer subnet create --domain-ids=${domainid} \
          --gateway={{ item.gw }} \
          --mask={{ item.mask }} \
          --name={{ item.name }} \
          --tftp-id=1 --network={{ item.network }} \
          --dns-primary={{ item.dns }}
      with_items: "{{ sat6.subnets }}"
      when: item.gw is defined
      become: true
      ignore_errors: yes
      args:
        creates: /root/.setup/step5
  
    - name: "Creating aws subnets and adding to domains"
      shell: |
          domainid=$(hammer domain list  | grep "| {{ item.domain }}" | awk '{print $1}')
          hammer subnet create --domain-ids=${domainid} \
          --prefix={{ item.prefix }} \
          --mask={{ item.mask }} \
          --name={{ item.name }} \
          --network={{ item.network }}
      with_items: "{{ sat6.subnets }}"
      when: item.prefix is defined
      ignore_errors: yes
      become: true
      args:
        creates: /root/.setup/step5

    - name: "Subnet creation Complete"
      shell: touch /root/.setup/step5
      become: true
      args:
        creates: /root/.setup/step5
  
    - name: "Adding Domains to Orgs and Locations"
      become: true
      ignore_errors: yes
      shell: |
          domainid=$(hammer domain list  | grep "| {{ item.1 }}" | awk '{print $1}')
          hammer organization add-domain --domain-id=${domainid} --name '{{ item.0.name }}'
      with_subelements:
        - "{{ sat6.orgs }}"
        - domains
      args:
        creates: /root/.setup/step6
  
    - name: "Adding Default Domain to Orgs and Locations"
      shell: |
          domainid=$(hammer domain list  | grep "| {{ sat6_default_domain }}" | awk '{print $1}')
          hammer organization add-domain --domain-id=${domainid} --name '{{ sat6_default_org }}'
      become: true
      args:
        creates: /root/.setup/step6

    - name: "Subnet creation Complete"
      shell: touch /root/.setup/step6
      become: true
      args:
        creates: /root/.setup/step6
  
    - name: "Adding Subnets to Orgs"
      shell: |
          subnetid=$(hammer subnet list  | grep {{ item.1 }} | awk '{print $1}')
          hammer organization add-subnet --subnet-id=${subnetid} --name '{{ item.0.name }}'
      become: true
      with_subelements:
        - "{{ sat6.orgs }}"
        - subnets
      args:
        creates: /root/.setup/step7
  
    - name: "Adding Default Subnet to Orgs"
      shell: |
          subnetid=$(hammer subnet list  | grep {{ sat6_default_subnet }} | awk '{print $1}')
          hammer organization add-subnet --subnet-id=${subnetid} --name '{{ sat6_default_org }}'
      become: true
      args:
        creates: /root/.setup/step7

    - name: "Add subnet to org Complete"
      shell: touch /root/.setup/step7
      become: true
      args:
        creates: /root/.setup/step7
  
    - name: "Adding Domains to Locations"
      shell: |
          domainid=$(hammer domain list  | grep "| {{ item.domain }}" | awk '{print $1}')
          hammer location add-domain --domain-id=${domainid} --name '{{ item.location }}'
      become: true
      with_items: "{{ sat6.subnets }}"
      args:
        creates: /root/.setup/step8
  
    - name: "Adding Default Domain to Locations"
      shell: |
          domainid=$(hammer domain list  | grep "| {{ sat6_default_domain }}" | awk '{print $1}')
          hammer location add-domain --domain-id=${domainid} --name '{{ sat6_default_location }}'
      become: true
      args:
        creates: /root/.setup/step8

#    - name: "Removing Default Domain from Default Location"
#      shell: |
#          hammer location remove-domain --id=2 --domain '{{ sat6_default_domain }}' && \
#          touch /root/.setup/step8a
#      args:
#        creates: /root/.setup/step8a

    - name: "Add Domains to location Complete"
      shell: touch /root/.setup/step8
      become: true
      args:
        creates: /root/.setup/step8
  
    - name: "Adding Subnets to Locations"
      shell: |
          subnetid=$(hammer subnet list  | grep {{ item.name }} | awk '{print $1}')
          hammer location add-subnet --subnet-id=${subnetid} --name '{{ item.location }}'
      become: true
      with_items: "{{ sat6.subnets }}"
      args:
        creates: /root/.setup/step9
  
  
#    - name: "Removing default subnet from Default Location"
#      shell: |
#          hammer location remove-subnet --id 2 --subnet default && \
#          touch /root/.setup/step9a
#      args:
#        creates: /root/.setup/step9a

    - name: "Adding Default Subnet to Locations"
      shell: |
          subnetid=$(hammer subnet list  | grep {{ sat6_default_subnet }} | awk '{print $1}')
          hammer location add-subnet --subnet-id=${subnetid} --name '{{ sat6_default_location }}'
      become: true
      args:
        creates: /root/.setup/step9
  
    - name: "Add Subnets to location Complete"
      shell: touch /root/.setup/step9
      become: true
      args:
        creates: /root/.setup/step9
  when: subnetstep.stdout == "false"

  always:
    - name: "Subnet section complete"
      debug:  msg="Looks like we are done with subnet and domain section"

#  #template:
#  copy:
#      dest: /tmp/manifest.zip
#      #src: "satellite/{{ sat6_manifest }}"
#      src: "/tmp/{{ sat6_manifest }}"
#      owner: root
#      group: root
#      mode: 0644
#      remote_src: no
#  become: true

- name: "Disable firewall"
  service:
    name: "firewalld"
    state: "stopped"
    enabled: no
  become: true

- name: "Copy over manifest from tower to the sat server"
  ansible.builtin.get_url:
    url: "http://10.55.102.5/{{ sat6_manifest }}"
    dest: /tmp/manifest.zip
    mode: '0444'
  become: true

- name: "Provisioning Satellite 6 - upload and refresh manifest"
  shell: |
      hammer subscription upload --file /tmp/manifest.zip --organization "{{ sat6_default_org }}" && \
      hammer subscription refresh-manifest --organization "{{ sat6_default_org }}" && \
      touch /root/.setup/step10
  become: true
  args:
    creates: /root/.setup/step10
#
#- name: loop through products, add repos
#  include: add-sat6-products.yml
#  loop: "{{ sat6_product_repomap }}"
#  loop_control:
#    loop_var: product
#
- name: Loop over the repos
  ansible.builtin.include_tasks: add-repos.yml
  loop: "{{ sat6_product_repomap }}"
  loop_control:
    loop_var: products

- name: "Publish BASE content view"
  redhat.satellite.content_view_version:
    username: "{{ sat6_user }}"
    password: "{{ sat6_pass }}"
    server_url: "{{ sat6_url }}"
    validate_certs: no
    content_view: "{{ sat6.content_view }}"
    organization: "{{ sat6.default_org }}"

#- name: "Provisioning Satellite 6 - base repositories"
#  shell: |
#      hammer repository-set enable \
#      --name "{{ item.name }}" \
#      --releasever "7Server" --basearch "x86_64" \
#      --product "{{ item.product }}" --organization "{{ sat6_default_org }}"
#  become: true
#  with_items: "{{ sat6_enabled_repos }}"
#  ignore_errors: yes
#  args:
#    creates: /root/.setup/step11a
#
- name: "Provisiong base repos complete"
  shell: touch /root/.setup/step11a
  args:
    creates: /root/.setup/step11a
  become: true

#- name: "Provisioning Satellite 6 - Tools repos without a releaseversion"
#  ignore_errors: yes
#  shell: |
#      hammer repository-set enable \
#      --name "{{ item.name }}" \
#      --basearch "x86_64" \
#      --product "{{ item.product }}" --organization "{{ sat6_default_org }}"
#  become: true
#  with_items:
#    - "{{ sat6_enabled_repos_tools }}"
#  args:
#    creates: /root/.setup/step11b
#
#- name: "Repo config Complete"
#  shell: touch /root/.setup/step11b
#  become: true
#  args:
#    creates: /root/.setup/step11b


- name: "Provisioning Satellite 6 - Syncing RHEL Product Content. This takes 100+ mins with all the repos to sync..."
  ignore_errors: yes
  shell: |
      hammer product synchronize --name "{{ item.name }}" \
      --organization "{{ sat6_default_org }}" --async
  become: true
  with_items:
    - "{{ sat6_product_repomap }}"
  args:
    creates: /root/.setup/step12

- name: "Product Sync Complete"
  shell: |
    touch /root/.setup/step12
  become: true
  args:
    creates: /root/.setup/step12

- name: "Provisioning Satellite 6 Host Collection"
  shell: |
      hammer host-collection create --name={{ sat6_default_hostcollection }} --organization "{{ sat6_default_org }}" && \
      touch /root/.setup/step13
  become: true
  args:
    creates: /root/.setup/step13

- name: "Provisioning Satellite 6 Lifecycle"
  ignore_errors: yes
  shell: |
      hammer lifecycle-environment create --name "{{ item.name }}" \
      --description "Environment for {{ sat6_default_org }}'s {{ item.name }} Team" \
      --prior "{{ item.prior }}" --organization "{{ sat6_default_org }}"
  become: true
  with_items: "{{ sat6.environments }}"
  args:
    creates: /root/.setup/step14

#- name: "Provisioning Satellite 6 Puppet Environments"
#  shell: |
#      hammer puppet-environment create --name {{ sat6_default_environment }} --locations {{ sat6_default_location }} --organizations {{ sat6_default_org }} || true
#  args:
#    creates: /root/.setup/step14

- name: "Provisionging Lifecycle Complete"
  shell: touch /root/.setup/step14
  become: true
  args:
    creates: /root/.setup/step14

- name: "Get the ids of all the repos"
  shell: |
    hammer --csv repository list --organization-id 1 --fields id | grep -v 'Id'
  become: true
  register: availrepoids
  args:
    creates: /root/.setup/step15

- name: "Set the available repos fact"
  set_fact:
    availablerepos: "{{ availrepoids.stdout.split() | join(',') }}"

- name: "debug the repos fact"
  debug: var=availablerepos

- name: "Creating Base Content View"
  ignore_errors: yes
  shell: |
      set -x
      hammer content-view create --name "Base" \
      --description "Base operating system" \
      --repository-ids "{{ availablerepos }}" \
      --organization "{{ sat6_default_org }}"
  become: true
  args:
    creates: /root/.setup/step15

- name: "Publishing Base Content View"
  ignore_errors: yes
  shell: |
      hammer content-view publish --name "Base" \
      --description "Initial content view for our operating system" \
      --organization "{{ sat6_default_org }}" && \
      touch /root/.setup/step15
  become: true
  args:
    creates: /root/.setup/step15

- name: "Promoting Environments {{ sat6.environments }}"
  ignore_errors: yes
  become: true
  shell: |
      hammer content-view version promote --content-view "Base" --version 1 \
      --to-lifecycle-environment "{{ item.name }}" --organization "{{ sat6_default_org }}"
  with_items: "{{ sat6.environments }}"
  args:
    creates: /root/.setup/step16

- name: "Promotion Complete"
  shell: touch /root/.setup/step16
  become: true
  args:
    creates: /root/.setup/step16

- name: "Creating activation keys for environments"
  ignore_errors: yes
  shell: |
    hammer activation-key create --name "{{ sat6_default_org }}-{{ item.name }}-key" \
    --unlimited-hosts --description "Example activation key for {{ item.name }}" \
    --lifecycle-environment "{{ item.name }}" --content-view "Base" \
    --organization "{{ sat6_default_org }}"
  become: true
  with_items: "{{ sat6.environments }}"
  args:
    creates: /root/.setup/step17

- name: "Activation keys Complete"
  shell: touch /root/.setup/step17
  become: true
  args:
    creates: /root/.setup/step17

- name: "Adding subs to activation keys for environments"
  ignore_errors: yes
  shell: |
    subid=$(hammer subscription list --organization "{{ sat6_default_org }}"| grep "{{ item[1] }}"| cut -f1 -d\|)
    hammer activation-key add-subscription --name "{{ sat6_default_org }}-{{ item[0]['name'] }}-key" \
    --subscription-id ${subid} \
    --organization "{{ sat6_default_org }}"
  become: true
  with_nested:
    - "{{ sat6.environments }}"
    - "{{ sat6.subs_for_activationkeys }}"
  args:
    creates: /root/.setup/step18

- name: "Adding subs to activation keys Complete"
  shell: touch /root/.setup/step18
  become: true
  args:
    creates: /root/.setup/step18

- name: "Enabling sat tools repo in the keys"
  ignore_errors: yes
  shell: |
    hammer activation-key content-override --name "{{ sat6_default_org }}-{{ item.name }}-key" \
    --content-label rhel-7-server-satellite-tools-{{ satellite_version }}-rpms \
    --value 1 --organization "{{ sat6_default_org }}"
  become: true
  with_items: "{{ sat6.environments }}"
  args:
    creates: /root/.setup/step19

- name: "Enabling rhel8 sat tools repo in the keys"
  ignore_errors: yes
  shell: |
    hammer activation-key content-override --name "{{ sat6_default_org }}-{{ item.name }}-key" \
    --content-label satellite-tools-{{ satellite_version }}-for-rhel-8-x86_64-rpms \
    --value 1 --organization "{{ sat6_default_org }}"
  become: true
  with_items: "{{ sat6.environments }}"
  args:
    creates: /root/.setup/step19

- name: "Step Complete"
  shell: touch /root/.setup/step19
  become: true
  args:
    creates: /root/.setup/step19

- name: "Adding host collection to activation keys"
  ignore_errors: yes
  shell: |
    hammer activation-key add-host-collection --name={{ sat6_default_org }}-{{ item.name }}-key --host-collection={{ sat6_default_hostcollection }} --organization={{ sat6_default_org }}
  become: true
  with_items: "{{ sat6.environments }}"
  args:
    creates: /root/.setup/step20


- name: "Step Complete"
  shell: touch /root/.setup/step20
  become: true
  args:
    creates: /root/.setup/step20

- name: "Add all subscriptions to activation keys"
  ignore_errors: yes
  become: true
  shell: |
    for i in $(hammer --csv activation-key list --organization={{ sat6_default_org }} | awk -F, {'print $1'} | grep -vi '^ID'); do \
    for j in $(hammer --csv subscription list --organization={{ sat6_default_org }}  | awk -F, {'print $1'} | grep -vi '^ID'); do \
    hammer activation-key add-subscription --id ${i} --subscription-id ${j}; done; done && \
    touch /root/.setup/step21
  args:
    creates: /root/.setup/step21

- name: "Add partition table to OS"
  ignore_errors: yes
  become: true
  shell: |
    PARTID=$(hammer --csv partition-table list | grep 'Kickstart default,' | awk -F, {'print $1'})
    for i in $(hammer --csv os list | awk -F, {'print $1'} | grep -vi '^ID')
    do
    hammer partition-table add-operatingsystem --id="${PARTID}" --operatingsystem-id="${i}"  
    done && \
    touch /root/.setup/step22
  args:
    creates: /root/.setup/step22

- name: "Clone the Default User Data Kickstart"
  ignore_errors: yes
  become: true
  shell: |
    hammer template clone --name 'Kickstart default user data' --new-name '{{ sat6_default_org }} User Data' && \
    touch /root/.setup/step23a
  args:
    creates: /root/.setup/step23a

- name: "Update the new user data template"
  become: true
  ignore_errors: yes
  shell: |
    USERDATAID=$(hammer --csv template list | grep "{{ sat6_default_org }}" | awk -F, {'print $1'})
    hammer template update --file /var/tmp/user-data-template.txt --id ${USERDATAID} && \
    touch /root/.setup/step23b
  args:
    creates: /root/.setup/step23b

- name: "Add kickstart pxe template to OS"
  ignore_errors: yes
  become: true
  shell: |
    PXEID=$(hammer --csv template list | grep 'Kickstart default PXELinux' | awk -F, {'print $1'})
    SATID=$(hammer --csv template list | grep ',Kickstart default,' | grep 'provision' | awk -F, {'print $1'})
    USERDATAID=$(hammer --csv template list | grep "{{ sat6_default_org }}" | awk -F, {'print $1'})
    for i in $(hammer --csv os list | awk -F, {'print $1'} | grep -vi '^ID')
    do
    hammer template add-operatingsystem --id="${PXEID}" --operatingsystem-id="${i}"
    hammer os set-default-template --id="${i}" --provisioning-template-id="${PXEID}"
    hammer os add-provisioning-template --id="${i}" --provisioning-template-id="${SATID}"
    hammer os add-provisioning-template --id="${i}" --provisioning-template-id="${USERDATAID}"
    hammer os set-default-template --id="${i}" --provisioning-template-id="${SATID}"
    hammer os set-default-template --id="${i}" --provisioning-template-id="${USERDATAID}"
    done && \
    touch /root/.setup/step23
  args:
    creates: /root/.setup/step23

- name: "Add operating systems"
  ignore_errors: yes
  shell: |
    hammer os list | grep "{{ item }}" || \
    hammer os create --name {{ item.split()[0] }} --major {{ item.split()[1] }} --architectures="x86_64"
  loop: "{{ sat6_managed_systems }}"
  ignore_errors: yes
  args:
    creates: /root/.setup/step23aa

- name: "Adding os done"
  ignore_errors: yes
  become: true
  shell: touch /root/.setup/step23aa
  args:
    creates: /root/.setup/step23aa

#- name: "Update OS with medium"
#  shell: |
#    MEDID=$(hammer --csv medium list | grep 'Kickstart_x86_64_7Server' | awk -F, {'print $1'})
#    OSID=$(hammer --csv os list | grep 'RedHat 7' | awk -F, {'print $1'})
#    for os in $OSID
#    do
#      hammer os update --id ${os} --medium-ids ${MEDID}
#    done
#    touch /root/.setup/setup23bb
#  args:
#    creates: /root/.setup/step23bb

- name: "Add RHEL7 host group for each domain"
  ignore_errors: yes
  become: true
  shell: |
    #MEDID=$(hammer --csv medium list | grep 'Kickstart_x86_64_7Server' | awk -F, {'print $1'})
    PARTID=$(hammer --csv partition-table list | grep 'Kickstart default,' | awk -F, {'print $1'})
    OSID=$(hammer --csv os list | grep 'RedHat 7' | awk -F, {'print $1'})
    LCID=$(hammer lifecycle-environment list --organization {{ sat6_default_org }} | grep '{{ sat6_default_environment }}' | awk -F\| {'print $1'})
    CAID=1
    CSID=1
    PROXYID=1
    for os in $OSID
    do
      osname=$(hammer os info --id ${os} |grep Title:|sed -e 's/Title:              //g')
      hammer hostgroup create --puppet-environment {{ sat6_default_environment }} --architecture="x86_64" --domain="{{ item.domain }}"  --content-source-id="${CSID}"  --locations="{{ item.location }}" \
      --query-organization="{{ sat6_default_org }}" --name="{{ sat6_default_hostgroup }} for {{ item.domain }}" --subnet="{{ item.name }}" --partition-table-id="${PARTID}" \
      --operatingsystem-id="${os}" --puppet-ca-proxy-id="${CAID}" --puppet-proxy-id="${PROXYID}" --content-view="Base" --lifecycle-environment-id="${LCID}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ item.domain }}" --name "ssh_authorized_keys"  --value "{{ automation_user_pub_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ item.domain }}" --name "ansible_host_config_key"  --value "{{ tower_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ item.domain }}" --name "ansible_tower_fqdn"  --value "{{ tower_server }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ item.domain }}" --name "ansible_job_template_id"  --value "{{ tower_jobid }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ item.domain }}" --name "kt_activation_keys"  --value "{{ item.activation_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ item.domain }}" --name "ansible_tower_provisioning"  --value "true"
    done
  args:
    creates: /root/.setup/step24
  with_items: "{{ sat6.subnets }}"

- name: "Add RHEL7 host group for default domain"
  ignore_errors: yes
  become: true
  shell: |
    #MEDID=$(hammer --csv medium list | grep 'Kickstart_x86_64_7Server' | awk -F, {'print $1'})
    PARTID=$(hammer --csv partition-table list | grep 'Kickstart default,' | awk -F, {'print $1'})
    OSID=$(hammer --csv os list | grep "RedHat 7" | awk -F, {'print $1'})
    LCID=$(hammer lifecycle-environment list --organization {{ sat6_default_org }} | grep '{{ sat6_default_environment }} | Library' | awk -F\| {'print $1'})
    CAID=1
    CSID=1
    PROXYID=1
    for os in $OSID
    do
      osname=$(hammer os info --id ${os} |grep Title:|sed -e 's/Title:              //g')
      #hammer hostgroup create --environment {{ sat6_default_environment }} --architecture="x86_64" --domain="{{ sat6_default_domain }}" --content-source-id="${CSID}" --medium-id="${MEDID}" --locations="{{ sat6_default_location }}"
      hammer hostgroup create --environment {{ sat6_default_environment }} --architecture="x86_64" --domain="{{ sat6_default_domain }}" --content-source-id="${CSID}" --locations="{{ sat6_default_location }}" \
    --query-organization="{{ sat6_default_org }}" --name="{{ sat6_default_hostgroup }} for {{ sat6_default_domain }}" --subnet="{{ sat6_default_subnet }}" --partition-table-id="${PARTID}" \
    --operatingsystem-id="${os}" --puppet-ca-proxy-id="${CAID}" --puppet-proxy-id="${PROXYID}" --openscap-proxy-id=1 --content-view="Base" --lifecycle-environment-id="${LCID}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ sat6_default_domain }}" --name "sshkey"  --value "{{ automation_user_pub_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ sat6_default_domain }}" --name "tower_key"  --value "{{ tower_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ sat6_default_domain }}" --name "tower_server"  --value "{{ tower_server }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup }} for {{ sat6_default_domain }}" --name "tower_jobid"  --value "{{ tower_jobid }}"
    done
  args:
    creates: /root/.setup/step24

- name: "Host groups to domain Complete"
  ignore_errors: yes
  become: true
  shell: touch /root/.setup/step24
  args:
    creates: /root/.setup/step24

- name: "Add RHEL8 host group for default domain"
  ignore_errors: yes
  become: true
  shell: |
    PARTID=$(hammer --csv partition-table list | grep 'Kickstart default,' | awk -F, {'print $1'})
    OSID=$(hammer --csv os list | grep "RedHat 8" | awk -F, {'print $1'})
    LCID=$(hammer lifecycle-environment list --organization {{ sat6_default_org }} | grep '{{ sat6_default_environment }} | Library' | awk -F\| {'print $1'})
    CAID=1
    CSID=1
    PROXYID=1
    for os in $OSID
    do
      osname=$(hammer os info --id ${os} |grep Title:|sed -e 's/Title:              //g')
      hammer hostgroup create --environment {{ sat6_default_environment }} --architecture="x86_64" --domain="{{ sat6_default_domain }}" --content-source-id="${CSID}" --locations="{{ sat6_default_location }}" \
    --query-organization="{{ sat6_default_org }}" --name="{{ sat6_default_hostgroup_rhel8 }} for {{ sat6_default_domain }}" --subnet="{{ sat6_default_subnet }}" --partition-table-id="${PARTID}" \
    --operatingsystem-id="${os}" --puppet-ca-proxy-id="${CAID}" --puppet-proxy-id="${PROXYID}" --openscap-proxy-id=1 --content-view="Base" --lifecycle-environment-id="${LCID}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup_rhel8 }} for {{ sat6_default_domain }}" --name "sshkey"  --value "{{ automation_user_pub_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup_rhel8 }} for {{ sat6_default_domain }}" --name "tower_key"  --value "{{ tower_key }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup_rhel8 }} for {{ sat6_default_domain }}" --name "tower_server"  --value "{{ tower_server }}"
      hammer hostgroup set-parameter --hostgroup "{{ sat6_default_hostgroup_rhel8 }} for {{ sat6_default_domain }}" --name "tower_jobid"  --value "{{ tower_jobid }}"
    done
  args:
    creates: /root/.setup/step24a

- name: "Host groups to domain Complete"
  become: true
  shell: touch /root/.setup/step24a
  args:
    creates: /root/.setup/step24a

- name: "Set unattended_url to ip address"
  ignore_errors: yes
  become: true
  shell: |
    hammer settings set \
    --name unattended_url \
    --value "http://$(ip a | grep -E 'inet\s' | awk 'NR==2' | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}/[0-9]+' | grep -oE '^[^/]*')" && \
    touch /root/.setup/step28
  args:
    creates: /root/.setup/step28

- name: "Set Capsule to proper location"
  ignore_errors: yes
  become: true
  shell: |
    hammer capsule update --id 1 --locations {{ sat6_default_location }} && \
    touch /root/.setup/step29
  args:
    creates: /root/.setup/step29
    
- name: "Open firewall port for external access to Satellite at sat6.dev.maskedadmins.com:8448"
  ignore_errors: yes
  uri:
    url: "https://{{ tower_server }}:443/api/v2/job_templates/28/launch/"
    method: POST
    validate_certs: false
    user: "{{ tower_user }}"
    password: "{{ tower_pass }}"
    status_code: 204
    body: 
      extra_vars:
        int_ip: "{{ ansible_default_ipv4['address'] }}"
        ports:
          - inside: 443
            outside: 443
          - inside: 5647
            outside: 5647
          - inside: 5000
            outside: 5000
          - inside: 80
            outside: 80
          - inside: 8000
            outside: 8000
          - inside: 8140
            outside: 8140
          - inside: 8443
            outside: 8443
          - inside: 9090
            outside: 9090
    body_format: json
  when: ansible_local['awsroles'] is not defined

- include: "compute.yml"

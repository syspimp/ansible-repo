---
- name: "include tower stuff to populate sat6_server variable, or set it yourself somewhere"
  include: tower.yml

- name: "create new list variable to hold the results"
  set_fact:
    final_result: []

- name: "run first report on the sat6 server and save output"
  shell: "hammer report-template generate --id 125"
  register: reporttemplate
  delegate_to: "{{ sat6_server }}"

- name: "run second report on the sat6 server and save output"
  shell: "hammer --csv config-report list"
  register: configreports
  delegate_to: "{{ sat6_server }}"

- name: "create new variable to hold the csv header"
  set_fact:
    final_header: "{{ reporttemplate.stdout.split('\n')[0] }}, {{ configreports.stdout.split('\n')[0] }}"

- name: "loop over reporttemplate and add output of confighosts, matching on key of hostname"
  include: merge_reports.yml
  when: "'Id,Host' not in item"
  loop: "{{ reporttemplate.stdout.split('\n') }}"
  loop_control:
    index_var: report_row_num
    loop_var: report_contents

- name: "generate today's date"
  set_fact:
    date: "{{ lookup('pipe', 'date +\"%Y%m%d\"') }}"

- name: "generate the csv file in /tmp"
  template:
    src: "sat6-report.csv.j2"
    dest: "/tmp/sat6-report-{{ date }}.csv"
